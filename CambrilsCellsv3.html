<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cambrils Cells</title>

    <link rel="apple-touch-icon" href="./icons/monster.png">
    <link rel="shortcut icon" href="./icons/monster.png">

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#fafafa" />

<!-- S2 GEOMETRY -->
    <script src="https://unpkg.com/s2-geometry" crossorigin></script>

<!-- LEAFLET -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@latest/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@latest/dist/leaflet.js"></script>

<!-- LEAFLET HASH -->
    <script src="https://unpkg.com/leaflet-hash" crossorigin></script>

<!-- LEAFLET PANEL LAYERS -->
    <!-- link rel="stylesheet" href="./leaflet panel layers/leaflet-panel-layers.css" / -->
    <!-- script src="./leaflet panel layers/leaflet-panel-layers.js"></script -->

<!-- LEAFLET SEARCH -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search/dist/leaflet-search.src.css" crossorigin />
    <script src="https://unpkg.com/leaflet-search/dist/leaflet-search.src.js" crossorigin ></script>

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">

    <link rel="stylesheet" href="./css/style.css" />

<!-- JQUERY -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>

<!-- TABLETOP -->
    <script src='https://cdn.jsdelivr.net/npm/tabletop@1.6.2/src/tabletop.min.js'></script>

<!-- LEAFLET EXTRA MARKERS -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-extra-markers@1.0.6/src/assets/js/leaflet.extra-markers.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-extra-markers@1.0.6/dist/css/leaflet.extra-markers.min.css">

<!-- FONT AWESOME -->
<!-- link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" -->

<!-- LEAFLET CONTROL LOCATE -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
<script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.js" charset="utf-8"></script>

<!-- LEAFLET POLILINEMEASURE -->
<link rel="stylesheet" href="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.css" />
<script src="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.js"></script>

    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      html,
      body,
      main {
        height: 100%;
        weight: 100%;
      }
	.NumeroCoSi {font-size: 36px; text-align: center; color: red}  	// Tama√±o y color numero faltan para gyms
	.AlineaCenter { text-align: center }
    </style>

  </head>

  <body>
    <main id="map"></main>

  <script>


///////////////////////////////////////////////////////////////////
// Setup the Leaflet map (declaracion variables y constantes)
let ZoomMax = 20 ;	// Zoom Maximo
let ZoomVis = 3 ;	// A partir de que zoom se empieza ver mapa satelite (ZoomMax - ZoomVis)
// Grupos de marcadores
var LG_gym = new L.LayerGroup();
var LG_pokestop = new L.LayerGroup();
var LG_gymex = new L.LayerGroup();
var LG_propuestas = new L.LayerGroup();
var LG_aceptadas = new L.LayerGroup();
var LG_sugerencias = new L.LayerGroup();
var LG_ContadorPG = new L.LayerGroup();
var LG_Circle20m = new L.LayerGroup();
var LG_Ingress = new L.LayerGroup();

const map = L.map('map', {
  maxZoom: ZoomMax,
  layers: [LG_gym, LG_pokestop, LG_gymex,]
}).locate({setView: true }); //setView([22.57, 88.32403643149632], 15)

// eslint-disable-next-line no-unused-vars
const hash = new L.Hash(map);


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// The fabled Google Maps satellite layer :angelic choir:
/*
var Mcalles = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
    subdomains:['mt0','mt1','mt2','mt3'] , maxZoom: 25
});
var Mhibrido = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
    subdomains:['mt0','mt1','mt2','mt3'] , maxZoom: 25
});
var Msatelit = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
    subdomains:['mt0','mt1','mt2','mt3'] , maxZoom: 25
});
var Mterreno = L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', {
    subdomains:['mt0','mt1','mt2','mt3'] , maxZoom: 25
});

https://stackoverflow.com/questions/29692737/customizing-google-map-tile-server-url
*/

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Mapas calles y satellite


const tileSatellite = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
    subdomains:['mt0','mt1','mt2','mt3'] , maxZoom: ZoomMax ,
}).addTo(map);

const tileStreet = L.tileLayer('https://mts0.google.com/vt/lyrs=m&x={x}&y={y}&z={z}&apistyle=s.t%3A33|s.e%3Al|p.v%3Aoff', {
    subdomains:['mt0','mt1','mt2','mt3'] , maxZoom: ZoomMax ,
}).addTo(map);



///////////////////////////////////////////////////////////////////
// Controles
L.control.locate({
  flyTo: true,
  drawCircle: true,
  drawMarker: true,
  enableHighAccuracy:true
}).addTo(map);

L.control.polylineMeasure({
		//	  position: 'topright',
		//	  showClearControl: true,        // Show a control to clear all the measurements
			 }).addTo(map);
L.control.scale().addTo(map);

var overlayMaps =
	{
	"Gym": LG_gym,
	"Pokeparada": LG_pokestop,
	"Gym EX": LG_gymex,
	"Pedidas": LG_propuestas,
	"Sugerencias": LG_sugerencias,
	"Aceptadas": LG_aceptadas,
	"Total Po GY" : LG_ContadorPG,
	"20 Metros" : LG_Circle20m,
	"Ingress Portal" : LG_Ingress,
 	};

L.control.layers(null, overlayMaps).addTo(map);



///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Visusalizacion de mapa segun zoom

const updateTiles = () => {
  			const zoom = map.getZoom();

  			if (zoom >(ZoomMax- ZoomVis)) {
	  		 		tileStreet.setOpacity(1 - (zoom - (ZoomMax-ZoomVis)) / ZoomVis) ;
	  				tileSatellite.setOpacity(0 + (zoom - (ZoomMax-ZoomVis)) /ZoomVis);
  							}
  							else
			 				{
		         		tileStreet.setOpacity(1);
			 		tileSatellite.setOpacity(0);
			 				};
			  };
map.on('zoomend', updateTiles);


////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// ICONOS

let ipokestop = L.ExtraMarkers.icon ({
	icon: "fa-dice-d6",markerColor: "cyan",shape: "circle", prefix: "fas"
                                     }); // Icono Pokeparada
let ipropuesta = L.ExtraMarkers.icon ({
//	icon: "fa-tools",markerColor: "orange",shape: "square", prefix: "fas"
//	icon: 'fa-spinner',
	      icon: 'fa-tools',
        iconSize: '[48,64]',
        shape: 'square',
        markerColor: 'violet',
        prefix: 'fa',
        extraClasses: 'fa-spin'
                                     }); // Icono Propuesta
let igym =      L.ExtraMarkers.icon ({
	icon: "fa-egg" , markerColor: "yellow" , shape: "penta" , prefix: "fas" ,  iconSize: '[48,64]',
                                    }); // Icono Gimnasio
let igymex =    L.ExtraMarkers.icon ({
	icon: "fa-splotch" , markerColor: "yellow" , shape: "star" , prefix: "fas" , extraClasses: 'fa-pulse' ,  iconSize: '[48,64]',
                                     }); // Icono Gim ex
let iaceptada =    L.ExtraMarkers.icon ({
	icon: "fa-thumbs-up" , markerColor: "green-light" , shape: "circle" , prefix: "fas" ,  iconSize: '[48,64]',
                                     }); // Icono aceptada
let isugerencia =  L.ExtraMarkers.icon ({
	icon: "fa-question" , markerColor: "black" , shape: "circle" , prefix: "fas" ,   iconSize: '[48,64]',
                                     }); // Icono sugerencia
let iIngress = L.ExtraMarkers.icon ({
	icon: "fa-dice-d20",markerColor: "green-dark",shape: "circle", prefix: "fas"
                                     }); // Icono Ingress Portal
	  
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Cargar pokeparadas y gyms

var MarkerCirclerOptions = 		// Marker Circulo de 20 metros
    	{
	radius: 20,
	fillColor: "#ff0000",
	color: "#ff0000",
	weight: 1,
	opacity: 0.8,
	fillOpacity: 0.2,
	interactive: false,
//	bubblingMouseEvents = false,
	};
	  
var MarkerNumCell14 =				// Para contar pokestops y gyms en celdas 14
    	{
	Lat1 : 0,		// Latitud esquina superior izquierda
	Lon1 : 0,	    	// Longitud esquina superior izquierda
	Lat2 : 0,		// Latitud esquina inferior derecha
	Lon2 : 0,		// Longitud esquina inferior derecha
	ContMark : 1		// Contador de markadores misma celda
	};
ArrayMarkerNumCell14 = [];	// Array de celdas 14 con numero de pokeparadas y gyms

var ContMarkerNumCell14 = 0;	// Contador de celdas con marcadores



var code = "1rRcKbQqjrIVVVFO1smLvdVg-UrYrQ88ck0chL-I0Fss"

Tabletop.init(
  {
  key: code,
  callback: function(sheet, tabletop)
	{

	$.each( tabletop.sheets("gym").all(), function(i, gim)		// Marcadores Gimnsasios
		{
		var loc = new L.latLng(gim.latitude, gim.longitude);
		marker = new L.Marker(loc, {title: gim.nombre, icon: igym} );
		marker.bindPopup("<h2><b style='color: #ff8800'>" + gim.nombre + "<br>" + "</h2>" + gim.city + "</b></h2>" +
  " <h3><a href='http://maps.google.com/maps?q=" +gim.latitude+","+gim.longitude+ "'>" + gim.latitude +", "+ gim.longitude + "</a></h3>" +
  "<div id='infoboxpic'><div id='infoboxpicin'><div id='infoboxpicimg' style='background-image: url(" + gim.imagen + ");'></div></div></div>");
		marker.addTo(LG_gym);	// A√±adimos al grupo de gyms

		marker = new L.circle ( loc , MarkerCirclerOptions ).addTo(LG_Circle20m);
		
		ContarPOGYC14(loc);	//Contador de Pokeparadas en celda14

		
	//	map.addLayer(marker);
		});

	let contador = 1;		// Para saber en que linea de la hoja de datos se encuentra el marcador
	$.each( tabletop.sheets("pokestop").all(), function(i, pokestop)	// Marcadores Pokeparadas
	       {

		contador ++;	// Para saber en que linea de la hoja de datos se encuentra el marcador
		var loc = new L.latLng(pokestop.latitude, pokestop.longitude);
		marker = new L.Marker(loc, {title: pokestop.nombre, icon: ipokestop} );
		marker.bindPopup("<h2><b style='color: #0044ff'>" + pokestop.nombre + "<br>" + "</h2>" + pokestop.city + "     (" + contador + ")" + "</b></h2>" +
  " <h3><a href='http://maps.google.com/maps?q=" +pokestop.latitude+","+pokestop.longitude+ "'>" + pokestop.latitude+", "+pokestop.longitude + "</a></h3>" +
  "<div id='infoboxpic'><div id='infoboxpicin'><div id='infoboxpicimg' style='background-image: url(" + pokestop.imagen + ");'></div></div></div>");
  		marker.addTo(LG_pokestop);	// A√±adimos al grupo de pokestop

		marker = new L.circle ( loc , MarkerCirclerOptions ).addTo(LG_Circle20m);

		ContarPOGYC14(loc);	//Contador de Pokeparadas en celda14

		//	map.addLayer(marker);
    		});

	$.each( tabletop.sheets("gymex").all(), function(i, gymex)		// Marcadores Gimnasios EX
		{

		var loc = new L.latLng(gymex.latitude, gymex.longitude);
		marker = new L.Marker(loc, {title: gymex.nombre, icon: igymex} );
		marker.bindPopup("<h2><b style='color: #ffdd00'>" + gymex.nombre + "<br>" + "</h2>" + gymex.city + "</b></h2>" +
  " <h3><a href='http://maps.google.com/maps?q=" +gymex.latitude+","+gymex.longitude+ "'>" + gymex.latitude+", "+gymex.longitude + "</a></h3>" +
  "<div id='infoboxpic'><div id='infoboxpicin'><div id='infoboxpicimg' style='background-image: url(" + gymex.imagen + ");'></div></div></div>");
		marker.addTo(LG_gymex);	// A√±adimos al grupo de gym ex

		marker = new L.circle ( loc , MarkerCirclerOptions ).addTo(LG_Circle20m);

		ContarPOGYC14(loc);	//Contador de Pokeparadas en celda14

		//	map.addLayer(marker);
		});

	$.each( tabletop.sheets("Propuesta").all(), function(i, propuesta)		// Marcadores Pedidos
		{

		var loc = [propuesta.latitude, propuesta.longitude];
		marker = new L.Marker(new L.latLng(loc), {title: propuesta.nombre, icon: ipropuesta} );
		marker.bindPopup("<h2><b style='color: #44ff00'>" + propuesta.nombre + "<br>" + "</h2>" + propuesta.city + "</b></h2>" +
  " <h3><a href='http://maps.google.com/maps?q=" +propuesta.latitude+","+propuesta.longitude+ "'>" + propuesta.latitude+", "+propuesta.longitude + "</a></h3>" +
  "<div id='infoboxpic'><div id='infoboxpicin'><div id='infoboxpicimg' style='background-image: url(" + propuesta.imagen + ");'></div></div></div>");
		marker.addTo(LG_propuestas);	// A√±adimos al grupo de pedidas
	//	map.addLayer(marker);
		});

	$.each( tabletop.sheets("Aceptadas").all(), function(i, aceptada)		// Marcadores Aceptadas
		{

		var loc = new L.latLng(aceptada.latitude, aceptada.longitude);
		marker = new L.Marker( loc , {title: aceptada.nombre, icon: iaceptada} );
		marker.bindPopup("<h2><b style='color: #0044ff'>" + aceptada.nombre + "<br>" + "</h2>" + aceptada.city + "</b></h2>" +
  " <h3><a href='http://maps.google.com/maps?q=" +aceptada.latitude+","+aceptada.longitude+ "'>" + aceptada.latitude+", "+aceptada.longitude + "</a></h3>" +
  "<div id='infoboxpic'><div id='infoboxpicin'><div id='infoboxpicimg' style='background-image: url(" + aceptada.imagen + ");'></div></div></div>");
		marker.addTo(LG_aceptadas);	// A√±adimos al grupo de Aceptadas

		ContarPOGYC14(loc);	//Contador de Pokeparadas en celda14

	//	map.addLayer(marker);
		});

	contador = 1;		// Para saber en que linea de la hoja de datos se encuentra el marcador
	$.each( tabletop.sheets("Sugerencia").all(), function(i, sugerencia)
		{

		contador ++;		// Para saber en que linea de la hoja de datos se encuentra el marcador
		var loc = [sugerencia.latitude, sugerencia.longitude];
		marker = new L.Marker(new L.latLng(loc), {title: sugerencia.nombre, icon: isugerencia} );
		marker.bindPopup("<h2><b style='color: #444444'>" + sugerencia.nombre + "<br>" + "</h2>" + sugerencia.city + "     (" + contador + ")"  + "</b></h2>" +
  " <h3><a href='http://maps.google.com/maps?q=" +sugerencia.latitude+","+sugerencia.longitude+ "'>" + sugerencia.latitude+", "+sugerencia.longitude + "</a></h3>" +
  "<div id='infoboxpic'><div id='infoboxpicin'><div id='infoboxpicimg' style='background-image: url(" + sugerencia.imagen + ");'></div></div></div>");
		marker.addTo(LG_sugerencias);	// A√±adimos al grupo de Sugeridas
	//	map.addLayer(marker);
  		});
	
	$.each( tabletop.sheets("Ingress").all(), function(i, ingress)		// Marcadores Portales ingress
		{
		var loc = new L.latLng(ingress.latitude, ingress.longitude);
		
		marker = new L.circle ( loc , MarkerCirclerOptions ).addTo(LG_Ingress);	// radio 20 metros

		marker = new L.Marker(loc, {title: ingress.nombre, icon: iIngress} );
		marker.bindPopup("<h2><b style='color: #00AA00'>" + ingress.nombre + "<br>" + "</h2>" + ingress.city + "</b></h2>" +
  " <h3><a href='http://maps.google.com/maps?q=" +ingress.latitude+","+ingress.longitude+ "'>" + ingress.latitude +", "+ ingress.longitude + "</a></h3>" +
  "<div id='infoboxpic'><div id='infoboxpicin'><div id='infoboxpicimg' style='background-image: url(" + ingress.imagen + ");'></div></div></div>");
		marker.addTo(LG_Ingress);	// A√±adimos al grupo de portales ingress

		});
		
// Ponemos Marcadores con numero de pokeparadas y gyms en celda 14
	for (a = 0; a < ContMarkerNumCell14; a++)
		{
    		let i = ListIndex[a];
		let NumMark = ArrayMarkerNumCell14[i].ContMark;
		let TextMark = "";
		var loc= midPoint(ArrayMarkerNumCell14[i].Lat1,ArrayMarkerNumCell14[i].Lon1,ArrayMarkerNumCell14[i].Lat2,ArrayMarkerNumCell14[i].Lon2);
		let itotalpg =   L.ExtraMarkers.icon
			({
			icon: 'fa-number',
      			shape: 'penta',
      			markerColor: 'orange-dark',
                        iconColor: 'white',
			number: NumMark.toString(),
 			});
		if ( NumMark > 1 ) 
			{
			if ( NumMark < 6 ) 
				{
				NumMark = 6 - NumMark;
				} else if ( NumMark < 20 )
					{
					NumMark = 20 - NumMark;
					} else { NumMark = 0; };
                        };
		if ( NumMark > 0 ) 
			{
			TextMark = "<b> <p class='NumeroCoSi'>"+ NumMark +" </p> <p style='font-size:large; text-align:center'> M√°s para nuevo Gym </p></b>";
			} else { TextMark = "<b> <p class='NumeroCoSi'> M√°ximo </p> <p style='font-size:large; text-align:center'> N√∫mero de Gyms Alcanzado </p></b>"; };
                
						 
		marker = new L.Marker(loc, {title: "Total pokeparadas y gyms celda 14", icon: itotalpg} );
		
		marker.bindPopup( TextMark + "info:<br> Aparece Nuevo gym  <b> 2a | 6a | 20a</b>");
		marker.addTo(LG_ContadorPG);	// A√±adimos al grupo de totales PO GY
		};
	},
  wanted: [ "gym" , "pokestop" , "gymex" , "Propuesta" , "Aceptadas" , "Sugerencia" , "Ingress" ],
  debug: true
  });


//////////////////////////////////////////////////////////////////////////////////////////////////////
  // Contar Pokeparadas y Gyms en celdas 14
  const MaxArray = 2048-1;  // Espacio para el array de celdas (1024 ,2048,4096,8192)
  const AndIndex = 2048-1;  //
  var ListIndex = [];   // Array de indices
  function ContarPOGYC14(loc)
  	{
  	const cell = S2.S2Cell.FromLatLng(loc, 14);
  	const corners = cell.getCornerLatLngs();
	let MarkIndex= (cell.ij[0] ^ cell.ij[1]) & AndIndex;	// Creamos un indice en la tabla de arrays
  	MarkerNumCell14.Lat1= corners[1].lat;
  	MarkerNumCell14.Lon1= corners[1].lng;
  	MarkerNumCell14.Lat2= corners[3].lat;
  	MarkerNumCell14.Lon2= corners[3].lng;
  	var Nuevorepe=0;	// 1 = Nuevo o Repe
    	do
      		{
        	if ( ArrayMarkerNumCell14[MarkIndex] == undefined )
          		{
            		ArrayMarkerNumCell14[MarkIndex]= JSON.parse(JSON.stringify(MarkerNumCell14));
            		ListIndex[ContMarkerNumCell14]=MarkIndex;
            		ContMarkerNumCell14++;
            		Nuevorepe = 1;
         		} else
          		{
           		if( (ArrayMarkerNumCell14[MarkIndex].Lat1 == MarkerNumCell14.Lat1) && (ArrayMarkerNumCell14[MarkIndex].Lon1 == MarkerNumCell14.Lon1))
        			{
        			Nuevorepe=1;                     		//Celda repetida
        			ArrayMarkerNumCell14[MarkIndex].ContMark++	// Incrementamos contador de marcador en celda
              			} else
              			{
              			MarkIndex= (MarkIndex+1) & MaxArray;  // si array ocupado no igual, cogemos siguiente array
              			};
          		};
      		} while (Nuevorepe == 0);
	};

////////////////////////////////////////////////////////////////////////////////////////////////
// Calcular el medio entre 2 puntos
function midPoint(lat1,lon1,lat2,lon2)
	{
	let dLon = (lon2 - lon1) * Math.PI / 180;

	//convert to radians
	lat1 = lat1 * Math.PI / 180;
	lat2 = lat2 * Math.PI / 180;
	lon1 = lon1 * Math.PI / 180;

	let Bx = Math.cos(lat2) * Math.cos(dLon);
	let By = Math.cos(lat2) * Math.sin(dLon);
	let lat3 = Math.atan2(Math.sin(lat1) + Math.sin(lat2), Math.sqrt((Math.cos(lat1) + Bx) * (Math.cos(lat1) + Bx) + By * By));
	let lon3 = lon1 + Math.atan2(By, Math.cos(lat1) + Bx);

	return new L.latLng ((lat3 * 180 / Math.PI),(lon3 * 180 / Math.PI));  // Devolvemos valores a grados
};
	  
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Overlay the S2 cells
// CREDIT: S2 cell drawing pretty much borrowed directly from
// https://gitlab.com/AlfonsoML/pogo-s2/blob/93cc77c1973b4978610ff25a85273d290e2754a0/s2check.user.js

let regionLayer;
var ColorCell17= '#000000';
var ColorCell14= '#44EE44';

const updateMapGrid = () => {
  regionLayer.clearLayers();

  const bounds = map.getBounds();
  const seenCells = {};

  const levels = {
    17: {
      color: ColorCell17, 	//'#000000',
      opacity: 1,
      weight: 1,
        },
    14: {
      color: ColorCell14,	//'#22CC44',
      opacity: 0.9,
      weight: 3,
        },
      };

  const drawCell = (cell, options) => {
    // corner points
    const corners = cell.getCornerLatLngs();
    // the level 6 cells have noticible errors with non-geodesic lines - and the larger level 4 cells are worse
    // NOTE: we only draw two of the edges. as we draw all cells on screen, the other two edges will either be drawn
    // from the other cell, or be off screen so we don't care
    const region = L.polyline([corners[0], corners[1], corners[2]], {
      fill: false,
      clickable: false,
      ...options,
    });
    regionLayer.addLayer(region);
  };

  const drawCellAndNeighbors = (cell, options) => {
    const cellStr = cell.toString();
    if (!seenCells[cellStr]) {
      // cell not visited - flag it as visited now
      seenCells[cellStr] = true;
      // is it on the screen?
      const corners = cell.getCornerLatLngs();
      const cellBounds = L.latLngBounds([corners[0], corners[1]]).extend(corners[2]).extend(corners[3]);
      if (cellBounds.intersects(bounds)) {
        // on screen - draw it
        drawCell(cell, options);
        // and recurse to our neighbors
        const neighbors = cell.getNeighbors();
        for (let i = 0; i < neighbors.length; i++) {
          drawCellAndNeighbors(neighbors[i], options);
        };
      };
    };
  };

  // center cell
  const zoom = map.getZoom();

  Object.keys(levels).forEach(level => {
	const options = levels[level];
	if (level == 14 && zoom >= 15 ) 
		{
		const cell = S2.S2Cell.FromLatLng(map.getCenter(), level);
		drawCellAndNeighbors(cell, options);
		}
	else if (level == 17 && zoom >= 17 )
		{
		if ( zoom == (ZoomMax-1) ) { ColorCell17= '#FFFFFF'; };
		if ( zoom == (ZoomMax-2) ) { ColorCell17= '#000000'; };

		const cell = S2.S2Cell.FromLatLng(map.getCenter(), level);
		drawCellAndNeighbors(cell, options);
		};
	});
      };


regionLayer = L.layerGroup();
map.addLayer(regionLayer);

map.on('moveend', updateMapGrid);
updateTiles();
updateMapGrid();

</script>
</body>
</html>
