<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cambrils Cells</title>

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#fafafa" />

    <script src="https://unpkg.com/s2-geometry" crossorigin></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@latest/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@latest/dist/leaflet.js"></script>
    <!-- link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" crossorigin /-->
    <!-- script src="https://unpkg.com/leaflet" crossorigin></script -->

    <script src="https://unpkg.com/leaflet-hash" crossorigin></script>
    <script src='https://unpkg.com/leaflet.gridlayer.googlemutant@latest/Leaflet.GoogleMutant.js'></script>
    <script src="https://unpkg.com/leaflet-omnivore/leaflet-omnivore.min.js" crossorigin ></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" crossorigin />
    <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js" crossorigin ></script>

    <!-- link rel="stylesheet" href="https://raw.githack.com/route360/Leaflet.CondensedAttribution/master/dist/leaflet-control-condended-attribution.css" / -->
    <!-- script type="text/javascript" src="https://raw.githack.com/route360/Leaflet.CondensedAttribution/master/dist/leaflet-control-condended-attribution.js" ></script -->

    <!-- link rel="stylesheet" href="./leaflet panel layers/leaflet-panel-layers.css" / -->
    <!-- script src="./leaflet panel layers/leaflet-panel-layers.js"></script -->

    <!-- link rel="stylesheet" href="https://unpkg.com/leaflet-search/dist/leaflet-search.src.css" crossorigin / -->
    <!-- script src="https://unpkg.com/leaflet-search/dist/leaflet-search.src.js" crossorigin ></script -->

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDh5BJFxbVP4vwv4hpxyxifhuc_tQtUwCU" async defer ></script>

    <script src="https://use.fontawesome.com/releases/v5.11.2/js/all.js" ></script>
    <link rel="stylesheet" href="./css/style.css" />

    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
    <script src='./js/tabletop.min.js'></script>

    <link rel="stylesheet" href="./css/leaflet.extra-markers.min.css">
    <script src="./js/leaflet.extra-markers.min.js"></script>


    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      html,
      body,
      main {
        height: 100%;
        weight: 100%;
      }
    </style>

  </head>

  <body>
    <main id="map"></main>

  <script>


///////////////////////////////////////////////////////////////////
//* global L, S2, omnivore
//* Setup the Leaflet map

const map = L.map('map').locate({setView: true, maxZoom: 25}); //setView([22.57, 88.32403643149632], 15)

// eslint-disable-next-line no-unused-vars
const hash = new L.Hash(map);

L.control.locate({
  icon: 'fa-map-marker',
  flyTo: true,
  drawCircle: false,
  drawMarker: false,
}).addTo(map);

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// The fabled Google Maps satellite layer :angelic choir:
// eslint-disable-next-line no-unused-vars

const tileSatellite = L.gridLayer.googleMutant({
  type: 'satellite', // valid values are 'roadmap', 'satellite', 'terrain' and 'hybrid'
  opacity: 0,
  maxZoom: 25;
}).addTo(map);

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// And Mapbox' vector
// eslint-disable-next-line no-unused-vars

const tileStreet = L.tileLayer(
  'https://api.mapbox.com/styles/v1/scio/cjvuj7krb2j1g1cs29u8y3z49/tiles/256/{z}/{x}/{y}?access_token={accessToken}', {
    accessToken: 'pk.eyJ1Ijoic2NpbyIsImEiOiJjanZocmp0aXAwNjZ2NDNsamE3dXNwc2I1In0.zfAzKEDrAmDSqiOfS_naVw',
    // attribution: 'map tiles &copy; <a href="https://www.openstreetmap.org/">Mapbox</a>, <a href="https://creativecommons.org/licenses/by/3.0/us/">CC-BY</a> | map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a> | dataset from <a href="https://github.com/PoGOHWH/db-poi">pogohwh/db-poi</a>',
    maxZoom: 25,
  }).addTo(map);

const updateTiles = () => {
  const zoom = map.getZoom();
  if (zoom >= 15) tileStreet.setOpacity(1 - (zoom - 15) / 5)
  else tileSatellite.setOpacity(1);
  if (zoom <= 25) tileSatellite.setOpacity(1 - (25 - zoom) / 4)
  else tileSatellite.setOpacity(1);
};
map.on('zoomend', updateTiles);


////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// ICONOS

let ipokestop = L.ExtraMarkers.icon ({
	icon: "fa-dice-d6",markerColor: "cyan",shape: "circle", prefix: "fas"
                                     }); // Icono Pokeparada
let ipropuesta = L.ExtraMarkers.icon ({
//	icon: "fa-tools",markerColor: "orange",shape: "square", prefix: "fas"
//	icon: 'fa-spinner',
	icon: 'fa-tools',
        shape: 'square',
        markerColor: 'violet',
        prefix: 'fa',
        extraClasses: 'fa-spin'
                                     }); // Icono Propuesta
let igym =      L.ExtraMarkers.icon ({
	icon: "fa-egg",markerColor: "yellow",shape: "penta", prefix: "fas"
                                    }); // Icono Gimnasio
let igymex =    L.ExtraMarkers.icon ({
	icon: "fa-star",markerColor: "yellow",shape: "star", prefix: "fas" ,extraClasses: 'fa-pulse'
                                     }); // Icono Gim ex
let iaceptada =    L.ExtraMarkers.icon ({
	icon: "fa-thumbs-up",markerColor: "green-light",shape: "circle", prefix: "fas"
                                     }); // Icono aceptada
let isugerencia =  L.ExtraMarkers.icon ({
	icon: "fa-question",markerColor: "black",shape: "circle", prefix: "fas"
                                     }); // Icono sugerencia
/*
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Cargar pokeparadas y gyms

var code = "1rRcKbQqjrIVVVFO1smLvdVg-UrYrQ88ck0chL-I0Fss"
   // "11NuCbN1bKx9MZ6jx412OyRvBqb0l7k0ppFpmkDejIxc"
Tabletop.init({
  key: code,


  callback: function(sheet, tabletop){

    $.each( tabletop.sheets("gym").all(), function(i, gim) {
      var loc = [gim.latitude, gim.longitude]
      marker = new L.Marker(new L.latLng(loc), {title: gim.nombre, icon: igym} );
      marker.bindPopup("<h2><strong style='color: #ff8800'>" + gim.nombre + "<br>" + "</h2>" + gim.city + "</strong></h2>" +
  " <h3><a href='http://maps.google.com/maps?q=" +gim.latitude+","+gim.longitude+ "'>" + gim.latitude+", "+gim.longitude + "</a></h3>" +
  "<div id='infoboxpic'><div id='infoboxpicin'><div id='infoboxpicimg' style='background-image: url(" +gim.imagen + ");'></div></div></div>");

      map.addLayer(marker);
    })
    $.each( tabletop.sheets("pokestop").all(), function(i, pokestop) {

      var loc = [pokestop.latitude, pokestop.longitude]
      marker2 = new L.Marker(new L.latLng(loc), {title: pokestop.nombre, icon: ipokestop} );
      marker2.bindPopup("<h2><strong style='color: #0044ff'>" + pokestop.nombre + "<br>" + "</h2>" + pokestop.city + "</strong></h2>" +
  " <h3><a href='http://maps.google.com/maps?q=" +pokestop.latitude+","+pokestop.longitude+ "'>" + pokestop.latitude+", "+pokestop.longitude + "</a></h3>" +
  "<div id='infoboxpic'><div id='infoboxpicin'><div id='infoboxpicimg' style='background-image: url(" + pokestop.imagen + ");'></div></div></div>");

      map.addLayer(marker2);
    })
   $.each( tabletop.sheets("gymex").all(), function(i, gymex) {

     var loc = [gymex.latitude, gymex.longitude]
      marker3 = new L.Marker(new L.latLng(loc), {title: gymex.nombre, icon: igymex} );
      marker3.bindPopup("<h2><strong style='color: #ffdd00'>" + gymex.nombre + "<br>" + "</h2>" + gymex.city + "</strong></h2>" +
  " <h3><a href='http://maps.google.com/maps?q=" +gymex.latitude+","+gymex.longitude+ "'>" + gymex.latitude+", "+gymex.longitude + "</a></h3>" +
  "<div id='infoboxpic'><div id='infoboxpicin'><div id='infoboxpicimg' style='background-image: url(" + gymex.imagen + ");'></div></div></div>");

      map.addLayer(marker3);
    })
   $.each( tabletop.sheets("Propuesta").all(), function(i, propuesta) {

     var loc = [propuesta.latitude, propuesta.longitude]
      marker4 = new L.Marker(new L.latLng(loc), {title: propuesta.nombre, icon: ipropuesta} );
      marker4.bindPopup("<h2><strong style='color: #44ff00'>" + propuesta.nombre + "<br>" + "</h2>" + propuesta.city + "</strong></h2>" +
  " <h3><a href='http://maps.google.com/maps?q=" +propuesta.latitude+","+propuesta.longitude+ "'>" + propuesta.latitude+", "+propuesta.longitude + "</a></h3>" +
  "<div id='infoboxpic'><div id='infoboxpicin'><div id='infoboxpicimg' style='background-image: url(" + propuesta.imagen + ");'></div></div></div>");

      map.addLayer(marker4);
    })
   $.each( tabletop.sheets("Aceptadas").all(), function(i, aceptada) {

     var loc = [aceptada.latitude, aceptada.longitude]
      marker5 = new L.Marker(new L.latLng(loc), {title: aceptada.nombre, icon: iaceptada} );
      marker5.bindPopup("<h2><strong style='color: #0044ff'>" + aceptada.nombre + "<br>" + "</h2>" + aceptada.city + "</strong></h2>" +
  " <h3><a href='http://maps.google.com/maps?q=" +aceptada.latitude+","+aceptada.longitude+ "'>" + aceptada.latitude+", "+aceptada.longitude + "</a></h3>" +
  "<div id='infoboxpic'><div id='infoboxpicin'><div id='infoboxpicimg' style='background-image: url(" + aceptada.imagen + ");'></div></div></div>");

      map.addLayer(marker5);
    })
   let contador = 0
   $.each( tabletop.sheets("Sugerencia").all(), function(i, sugerencia) {

      contador = contador + 1
      var loc = [sugerencia.latitude, sugerencia.longitude]
      marker6 = new L.Marker(new L.latLng(loc), {title: sugerencia.nombre, icon: isugerencia} );
      marker6.bindPopup("<h2><strong style='color: #444444'>" + sugerencia.nombre + " (" + contador + ")" + "<br>" + "</h2>" + sugerencia.city + "</strong></h2>" +
  " <h3><a href='http://maps.google.com/maps?q=" +sugerencia.latitude+","+sugerencia.longitude+ "'>" + sugerencia.latitude+", "+sugerencia.longitude + "</a></h3>" +
  "<div id='infoboxpic'><div id='infoboxpicin'><div id='infoboxpicimg' style='background-image: url(" + sugerencia.imagen + ");'></div></div></div>");

      map.addLayer(marker6);
    })
  },
  wanted: [ "gym" , "pokestop" , "gymex" , "Propuesta" , "Aceptadas" , "Sugerencia" ],
  debug: true
});
*/

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Overlay the S2 cells
// CREDIT: S2 cell drawing pretty much borrowed directly from
// https://gitlab.com/AlfonsoML/pogo-s2/blob/93cc77c1973b4978610ff25a85273d290e2754a0/s2check.user.js
// eslint-disable-next-line prefer-const

let regionLayer;

const updateMapGrid = () => {
  regionLayer.clearLayers();

  const bounds = map.getBounds();
  const seenCells = {};

  const levels = {
    17: {
      color: '#ff7700',
      opacity: 0.6,
      weight: 1,
        },
    14: {
      color: '#00ff77',
      opacity: 0.4,
      weight: 3,
        },
      };

  const drawCell = (cell, options) => {
    // corner points
    const corners = cell.getCornerLatLngs();
    // the level 6 cells have noticible errors with non-geodesic lines - and the larger level 4 cells are worse
    // NOTE: we only draw two of the edges. as we draw all cells on screen, the other two edges will either be drawn
    // from the other cell, or be off screen so we don't care
    const region = L.polyline([corners[0], corners[1], corners[2]], {
      fill: false,
      clickable: false,
      ...options,
    });
    regionLayer.addLayer(region);
  };

  const drawCellAndNeighbors = (cell, options) => {
    const cellStr = cell.toString();
    if (!seenCells[cellStr]) {
      // cell not visited - flag it as visited now
      seenCells[cellStr] = true;
      // is it on the screen?
      const corners = cell.getCornerLatLngs();
      const cellBounds = L.latLngBounds([corners[0], corners[1]]).extend(corners[2]).extend(corners[3]);
      if (cellBounds.intersects(bounds)) {
        // on screen - draw it
        drawCell(cell, options);
        // and recurse to our neighbors
        const neighbors = cell.getNeighbors();
        for (let i = 0; i < neighbors.length; i++) {
          drawCellAndNeighbors(neighbors[i], options);
        };
      };
    };
  };

  // center cell
  const zoom = map.getZoom();

  Object.keys(levels).forEach(level => {
    const options = levels[level];
    if (zoom >= level) {
      const cell = S2.S2Cell.FromLatLng(map.getCenter(), level);
      drawCellAndNeighbors(cell, options);
    };
  });
};
/*
map.attributionControl.setPrefix('getting last update');
fetch('https://api.github.com/repos/pogohwh/db-poi/commits?path=poi.geojson')
  .then(res => res.json())
  .then(json => new Date(json[0].commit.author.date))
  .then(date => date.toLocaleString('en-IN-u-ca-iso8601', { dateStyle: 'medium', timeStyle: 'short' }))
  .then(dateString => map.attributionControl.setPrefix(`last updated on <strong>${dateString}</strong>`))
*/
regionLayer = L.layerGroup()
map.addLayer(regionLayer)
map.on('moveend', updateMapGrid)
updateTiles();
updateMapGrid()

</script>
</body>
</html>
